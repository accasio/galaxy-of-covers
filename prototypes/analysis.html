<html>
<head>
  <script src="../node_modules/d3/d3.js" charset="utf-8"></script>
  <script src="../node_modules/queue-async/queue.js" charset="utf-8"></script>
  <script src="../node_modules/underscore/underscore.js" charset="utf-8"></script>
  <link href='http://fonts.googleapis.com/css?family=Roboto:500' rel='stylesheet' type='text/css'>
  <style>
    body {
      font-family: Roboto;
    }
    .segment {
      stroke: rgb(57, 59, 121);
      stroke-width: 2px;
    }
    .version-line {
      stroke: rgb(57, 59, 121);
      fill: none;
    }
    .song-title {
      fill: rgb(57, 59, 121);
      font-size: 20pt;
      text-anchor: middle;
    }
    .version-name {
      fill: rgb(57, 59, 121);
      text-anchor: end;
      text-shadow: -1px 0px 0px #fff,
                   1px 0px 0px #fff,
                   0px 1px 0px #fff,
                   0px -1px 0px #fff;
    }
  </style>
</head>
<body>

<script type="text/javascript">



  var colorScale = d3.scale.category20b();

  function expandLoudnessData(segmentsData) {
    var data = [];
    segmentsData.forEach(function(d) {
      data.push({
        time: d.start,
        loudness: d.loudness_start
      });
      if (d.loudness_max_time > 0) {
        data.push({
          time: d.start + d.loudness_max_time,
          loudness: d.loudness_max
        });
      }
    });
    return data;
  }


  function renderSegments(songData, container, width, height) {

    var versionsData = songData.versions;

    var attr = 'loudness';
    var color = d3.scale.category20b();
    versionsData.forEach(function(version) {
      version.loudness = expandLoudnessData(version.analysis.segments);
    });

    var maxLength = d3.max(versionsData,
      function(version) { var last = _.last(version.analysis.segments); return last.start + last.duration; });

    var valueExtent = [
      d3.min(versionsData, function(v) { return d3.min(v.loudness, function(d) { return d[attr]; }); }),
      d3.max(versionsData, function(v) { return d3.max(v.loudness, function(d) { return d[attr]; }); })
    ];


    var timeScale = d3.scale.linear()
        .domain([0, maxLength])
        .range([0, width]);

    var valueScale = d3.scale.linear()
        .domain(valueExtent)
        .range([height, 0]);



    var line = d3.svg.line()
        .x(function(d) { return timeScale(d.time); })
        .y(function(d) { return valueScale(d[attr]); })
        .interpolate('linear');


    var vis = container.selectAll('.vis').data([songData]);
    vis.enter().append('g')
        .attr('class', 'vis');

    vis.append('text')
        .attr('class', 'song-title')
        .attr('x', width / 2)
        .attr('y', -10)
        .text(function(d) { return d.title; });


//    var segment = segmentsVis.selectAll('.segment').data(data);
//    segment.enter()
//      .append('line')
//        .attr('class', 'segment')
//        .attr('x1', function(d) { return timeScale(d.start); })
//        .attr('x2', function(d) { return timeScale(d.start + d.duration); })
//        .attr('y1', function(d) { return valueScale(d[attr]); })
//        .attr('y2', function(d) { return valueScale(d[attr]); });
//

    var version = vis.selectAll('.version')
        .data(versionsData);

    var versionEnter = version.enter().append('g')
        .attr('class', 'version')
        .attr('transform', function(d, i) { return 'translate('+[0, i*height]+')'; });

    versionEnter.append('path')
      .attr('class', 'version-line')
      .attr('d', function(d) { return line(d.loudness); })
      .attr('stroke', function(d) { return color(d.spotify.id); })

    versionEnter.append('text')
        .attr('class', 'version-name')
        .attr('x', width)
        .attr('y', height/2)
        .text(function(d) { return d.performer + ' (' + d.date + ')'; });

  }


  function renderAll(songData) {
    console.log(songData);

    var margin = {top: 50, right: 10, bottom: 20, left: 10};
    var versionHeight = 150,
        width = 800 - margin.left - margin.right,
        height = versionHeight * songData.versions.length - margin.top - margin.bottom;

    var svg = d3.select('body').append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom)
          .style('border', '1px solid #ccc')
        .append('g')
         .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    renderSegments(songData, svg, width, versionHeight);
  }



  d3.json('../data/out/songinfo-spotify-echonest.json', function(err, songsData) {
    var songData = _.first(songsData);
    songData.versions = songData.versions.filter(function(d) { return d.spotify; });

    var q = queue(1);
    songData.versions.forEach(function(v) {
        q.defer(d3.json, '../data/out/analysis/'+v.spotify.id+'.json');
    });

    q.awaitAll(function(err, analysisData) {
      songData.versions.forEach(function(v, i) {
        if (!analysisData[i]) console.warn('No analysis data for', i, v);

        v.analysis = analysisData[i];
      });

      if (!err) {
        renderAll(songData);
      }
    });
  });


</script>
</body>
</html>
