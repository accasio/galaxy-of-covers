<html>
<head>
  <script src="../node_modules/d3/d3.js" charset="utf-8"></script>
  <script src="../node_modules/queue-async/queue.js" charset="utf-8"></script>
  <script src="../node_modules/underscore/underscore.js" charset="utf-8"></script>
  <link href='http://fonts.googleapis.com/css?family=Roboto:500' rel='stylesheet' type='text/css'>
  <style>
    body {
      font-family: Roboto;
    }
    .pitch {
    }
    .loudness-line {
      stroke: rgb(57, 59, 121);
      fill: none;
      opacity: 0.1;
    }
    .pitch-line {
      stroke: red;
      fill: none;
    }
    .song-title {
      fill: rgb(57, 59, 121);
      font-size: 20pt;
      text-anchor: middle;
    }
    .version-name {
      fill: rgb(57, 59, 121);
      text-anchor: start;
      text-shadow: -1px 0px 0px #fff,
                   1px 0px 0px #fff,
                   0px 1px 0px #fff,
                   0px -1px 0px #fff;
    }
  </style>
</head>
<body>

<script type="text/javascript">


  var LIMIT_VERSIONS = 5;
  var colorScale = d3.scale.category20b();

  function prepareLoudnessData(segmentsData) {
    var data = [];
    segmentsData.forEach(function(d) {
      data.push({
        time: d.start,
        loudness: d.loudness_start
      });
      if (d.loudness_max_time > 0) {
        data.push({
          time: d.start + d.loudness_max_time,
          loudness: d.loudness_max
        });
      }
    });
    return data;
  }

  function preparePitchData(segmentsData) {
    var pitches = d3.range(12);
    return segmentsData.map(function(d) {
      return {
        time: d.start,
        maxPitch: _.max(pitches, function(i) { return d.pitches[i]; })
      }
    });
  }


  function renderSegments(songData, container, width, height) {

    var versionsData = songData.versions;

    var color = d3.scale.category20b();
    versionsData.forEach(function(version) {
      version.loudness = prepareLoudnessData(version.analysis.segments);
      version.maxPitch = preparePitchData(version.analysis.segments);
    });

    var maxLength = d3.max(versionsData,
      function(version) { var last = _.last(version.analysis.segments); return last.start + last.duration; });

    var valueExtent = [
      d3.min(versionsData, function(v) { return d3.min(v.loudness, function(d) { return d.loudness; }); }),
      d3.max(versionsData, function(v) { return d3.max(v.loudness, function(d) { return d.loudness; }); })
    ];


    var yRange = [height*0.1, height*0.8];

    var timeScale = d3.scale.linear()
        .domain([0, maxLength])
        .range([0, width]);

    var loudnessValueScale = d3.scale.linear()
        .domain(valueExtent)
        .range(yRange.reverse());

    var pitchScale = d3.scale.ordinal()
        .domain(d3.range(12))
        .rangeBands(yRange);



    var loudnessLine = d3.svg.line()
        .x(function(d) { return timeScale(d.time); })
        .y(function(d) { return loudnessValueScale(d.loudness); })
        .interpolate('linear');

    var pitchLine = d3.svg.line()
        .x(function(d) { return timeScale(d.time); })
        .y(function(d) { return pitchScale(d.maxPitch); })
        .interpolate('linear');


    var pitchColorScale =  d3.scale.linear()
        .domain([0, 1])
        .range(['white','steelblue'])
        .interpolate(d3.interpolateHcl);



    var vis = container.selectAll('.vis').data([songData]);
    vis.enter().append('g')
        .attr('class', 'vis');

    vis.append('text')
        .attr('class', 'song-title')
        .attr('x', width / 2)
        .attr('y', -10)
        .text(function(d) { return d.title; });


//    var segment = segmentsVis.selectAll('.segment').data(data);
//    segment.enter()
//      .append('line')
//        .attr('class', 'segment')
//        .attr('x1', function(d) { return timeScale(d.start); })
//        .attr('x2', function(d) { return timeScale(d.start + d.duration); })
//        .attr('y1', function(d) { return valueScale(d[attr]); })
//        .attr('y2', function(d) { return valueScale(d[attr]); });
//

    var version = vis.selectAll('.version')
        .data(versionsData);

    var versionEnter = version.enter().append('g')
        .attr('class', 'version')
        .attr('transform', function(d, i) { return 'translate('+[0, i*height]+')'; });


    var segment = versionEnter.selectAll('.segment')
        .data(function(d) { return d.analysis.segments; });
    var segmentEnter = segment.enter()
      .append('g')
        .attr('class', 'segment');



    var pitch = segmentEnter.selectAll('.pitch')
        .data(function(d) {
          return d.pitches
              .map(function(d,i) { return {pitch:i,value:d}; })
              .filter(function(d) { return d.pitch >= 1; })
        });

    pitch.enter()
        .append('rect')
        .attr('class', 'pitch')
        .attr('x', function(d) {
          var pd = d3.select(this.parentNode).datum();
          return timeScale(pd.start);
        })
        .attr('width', function(d) {
          var pd = d3.select(this.parentNode).datum();
          return timeScale(pd.duration);
        })
        .attr('y', function(d) { return pitchScale(d.pitch); })
        .attr('height', pitchScale.rangeBand())
        .attr('fill', function(d) { return pitchColorScale(d.value); });



    versionEnter.append('path')
      .attr('class', 'loudness-line')
      .attr('d', function(d) { return loudnessLine(d.loudness); })
      .attr('stroke', function(d) { return color(d.spotify.id); });
//
//    versionEnter.append('path')
//      .attr('class', 'pitch-line')
//      .attr('d', function(d) { return pitchLine(d.maxPitch); });



    versionEnter.append('text')
        .attr('class', 'version-name')
        .attr('x', 10)
        .attr('y', height/2)
        .text(function(d) { return d.performer + ' (' + d.date + ')'; });


  }


  function renderAll(songData) {
    console.log(songData);

    var margin = {top: 50, right: 10, bottom: 20, left: 10};
    var versionHeight = 150,
        width = 2500 - margin.left - margin.right,
        height = versionHeight * songData.versions.length;

    var svg = d3.select('body').append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom)
          .style('border', '1px solid #ccc')
        .append('g')
         .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    renderSegments(songData, svg, width, versionHeight);
  }



  d3.json('../data/out/songinfo-always-on-my-mind.json', function(err, songsData) {
    var songData = _.first(songsData);
    songData.versions = songData.versions
        .filter(function(d) { return d.spotify; })
        .sort(function(a,b) { return d3.descending(a.spotify.popularity, b.spotify.popularity); });

    if (LIMIT_VERSIONS) {
      songData.versions = _.take(songData.versions, LIMIT_VERSIONS);
    }

    var q = queue(1);
    songData.versions.forEach(function(v) {
        q.defer(d3.json, '../data/out/analysis/'+v.spotify.id+'.json');
    });

    q.awaitAll(function(err, analysisData) {
      songData.versions.forEach(function(v, i) {
        if (!analysisData[i]) console.warn('No analysis data for', i, v);
        v.analysis = analysisData[i];
      });

      if (!err) {
        renderAll(songData);
      }
    });
  });


</script>
</body>
</html>
